<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>ICPC — Jury</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: linear-gradient(160deg, #060b24, #182250 55%, #1f2f6b 100%);
      --card-bg: rgba(17, 23, 42, 0.78);
      --card-border: rgba(96, 165, 250, 0.35);
      --card-shadow: 0 18px 40px rgba(2, 6, 23, 0.45);
      --text-soft: rgba(203, 213, 225, 0.85);
      --accent: #60a5fa;
      --accent-strong: #93c5fd;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 24px;
      flex-wrap: wrap;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-group .title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .title-group .subtitle {
      font-size: 0.95rem;
      color: var(--accent-strong);
    }

    .controls {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.8);
    }

    .field input {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: #f8fafc;
      padding: 10px 14px;
      min-width: 140px;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.2s ease, background 0.2s ease;
    }

    .field input:focus {
      border-color: var(--accent);
      background: rgba(30, 41, 59, 0.95);
    }

    main {
      flex: 1;
      width: min(1200px, 100%);
      margin: 0 auto 32px;
      padding: 0 28px 28px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 24px;
    }

    .card {
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(18px);
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card h2 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
    }

    .meta {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .log {
      flex: 1;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(71, 85, 105, 0.45);
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 18px;
      padding-bottom: 18px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.4);
    }

    .log-entry:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      header {
        padding: 24px;
      }

      main {
        padding: 0 24px 24px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="title-group">
    <span class="title">ICPC Jury Console</span>
    <span class="subtitle" id="roomSummary">Watching room room1</span>
    <span class="subtitle" id="userSummary">Signed in as jury-alpha</span>
  </div>
  <div class="controls">
    <label class="field">Room code
      <input id="room" placeholder="e.g. room1" value="room1"/>
    </label>
    <label class="field">Username
      <input id="username" placeholder="e.g. jury-alpha" value="jury-alpha"/>
    </label>
  </div>
</header>

<main>
  <section class="card">
    <h2>Run stream</h2>
    <span class="meta" id="runMeta">No runs yet</span>
    <div class="log" id="runs"></div>
  </section>
  <section class="card">
    <h2>Submission verdicts</h2>
    <span class="meta" id="submitMeta">No submissions yet</span>
    <div class="log" id="subs"></div>
  </section>
</main>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  function resolveApiBase() {
    if (window.__ICPC_API_BASE) return window.__ICPC_API_BASE.replace(/\/$/, "");
    const { origin, protocol } = window.location;
    if (protocol?.startsWith("http") && origin && origin !== "null") {
      return origin.replace(/\/$/, "");
    }
    return "http://localhost:3000";
  }

  const API = resolveApiBase();
  const socket = io(API);
  const roomEl = document.getElementById("room");
  const roomSummary = document.getElementById("roomSummary");
  const usernameEl = document.getElementById("username");
  const userSummary = document.getElementById("userSummary");
  const runs = document.getElementById("runs");
  const subs = document.getElementById("subs");
  const runMeta = document.getElementById("runMeta");
  const submitMeta = document.getElementById("submitMeta");

  function currentUser() {
    return usernameEl.value.trim() || "Jury";
  }

  function updateUserSummary() {
    userSummary.textContent = `Signed in as ${currentUser()}`;
  }

  function join() {
    const roomId = roomEl.value.trim() || "room1";
    socket.emit("joinJury", roomId);
    roomSummary.textContent = `Watching room ${roomId}`;
  }

  join();
  roomEl.addEventListener("change", join);
  updateUserSummary();
  usernameEl.addEventListener("change", updateUserSummary);

  function prependLog(container, text) {
    const entry = document.createElement("div");
    entry.className = "log-entry";
    entry.textContent = text;
    container.prepend(entry);
  }

  socket.on("run_result", (r) => {
    const when = new Date(r.timestamp ?? Date.now()).toLocaleTimeString();
    const roomId = r.roomId || roomEl.value.trim() || "room1";
    const time = r.time ?? "0.0";
    const memory = r.memory ?? 0;
    const status = r.status ?? "Unknown";
    const actor = r.username || "Unknown";
    runMeta.textContent = `Last run • ${actor} • Room ${roomId} • ${status} • ${time}s / ${memory} KB`;
    const stdout = r.stdout ?? "";
    const stderr = r.stderr ?? "";
    const text = `[${when}] ${actor} @ Room ${roomId}\nStatus: ${status}\nTime: ${time}s • Memory: ${memory} KB\nStdout:\n${stdout}\n\nStderr:\n${stderr}`;
    prependLog(runs, text);
  });

  socket.on("submit_result_private", (r) => {
    const when = new Date(r.timestamp ?? Date.now()).toLocaleTimeString();
    const roomId = r.roomId || roomEl.value.trim() || "room1";
    const final = r.final ?? "Pending";
    const actor = r.username || "Unknown";
    submitMeta.textContent = `Last submission • ${actor} • Room ${roomId} • Problem ${r.problemId} • ${final}`;
    const lines = (r.verdicts || []).map(v => `#${v.idx}: ${v.v} (status: ${v.status}, time: ${v.time ?? "0.0"}s, memory: ${v.memory ?? 0} KB)`).join("\n");
    const text = `[${when}] ${actor} @ Room ${roomId} • Problem ${r.problemId}\nFinal verdict: ${final}${lines ? `\n${lines}` : ""}`;
    prependLog(subs, text);
  });
</script>
</body>
</html>
